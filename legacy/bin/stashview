#!/usr/bin/env bash
set -euo pipefail

# Name: stashview
# Category: git
# Description: Interactive git stash browser with apply/pop/drop actions.
# Usage:
#   stashview             # pick stash, show patch only
#   stashview --apply     # pick stash, git stash apply
#   stashview --pop       # pick stash, git stash pop
#   stashview --drop      # pick stash, git stash drop
#
# Notes:
#   - Must be run inside a git repo.
#   - Uses fzf with a patch preview (git stash show -p).

usage() {
  sed -n '4,40p' "$0" | sed 's/^# \?//'
}

case "${1-}" in
  -h|--help)
    usage
    exit 0
    ;;
esac

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]:-$0}")" && pwd)"
REPO_ROOT="$(cd -- "$SCRIPT_DIR/.." && pwd)"
# shellcheck source=../lib/git.sh disable=SC1091
. "$REPO_ROOT/lib/git.sh"
# shellcheck source=../lib/fzf.sh disable=SC1091
. "$REPO_ROOT/lib/fzf.sh"

if ! git_require_repo; then
  exit 1
fi

if ! fzf_require; then
  exit 1
fi

ACTION="show"

while [ "$#" -gt 0 ]; do
  case "$1" in
    --apply) ACTION="apply"; shift ;;
    --pop)   ACTION="pop";   shift ;;
    --drop)  ACTION="drop";  shift ;;
    -h|--help)
      sed -n '4,40p' "$0"
      exit 0
      ;;
    *)
      printf 'Error: unknown option: %s\n' "$1" >&2
      sed -n '4,40p' "$0" >&2
      exit 1
      ;;
  esac
done

stash_list="$(git stash list 2>/dev/null || true)"
if [ -z "$stash_list" ]; then
  printf 'No stashes found.\n'
  exit 0
fi

# shellcheck disable=SC2016  # preview command evaluated by fzf; $ref and {} are intentional.
preview='ref=$(printf "%s" {} | awk "{print \$1}"); git stash show -p "$ref" --color=always 2>/dev/null || git stash show "$ref" 2>/dev/null'

fzf_set_common_opts "stashview> " "Select a stash (ENTER). Default: show patch."
fzf_add_preview "$preview" "down,60%,border-top"

selection="$(
  printf '%s\n' "$stash_list" \
    | fzf "${FZF_COMMON_OPTS[@]}"
)" || exit 0

ref="$(printf '%s\n' "$selection" | awk '{print $1}')"
[ -z "$ref" ] && exit 0

case "$ACTION" in
  show)
    git stash show -p "$ref" --color=always | ${PAGER:-less} -R
    ;;
  apply)
    printf 'Applying %s\n' "$ref"
    git stash apply "$ref"
    ;;
  pop)
    printf 'Popping %s\n' "$ref"
    git stash pop "$ref"
    ;;
  drop)
    printf 'About to drop %s\n' "$ref"
    printf 'Proceed? [y/N]: '
    read -r reply
    case "$reply" in
      y|Y|yes|YES) git stash drop "$ref" ;;
      *) printf 'Aborted.\n' ;;
    esac
    ;;
esac
