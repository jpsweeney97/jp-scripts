#!/usr/bin/env bash
set -euo pipefail

# Name: jp-bootstrap
# Category: meta
# Description: Bootstrap jp-scripts on a fresh machine: configure PATH, create dirs, and run health checks.
# Usage:
#   jp-bootstrap            # dry-run: show what would be done
#   jp-bootstrap --apply    # make non-destructive changes (PATH line, dirs)
#
# Notes:
#   - Never runs arbitrary remote installers; only touches local files and runs jp-lint/jpdoctor.
#   - Intended to be run after cloning ~/Projects/jp-scripts on a new machine.

usage() {
  sed -n '4,40p' "$0" | sed 's/^# \?//'
}

APPLY=false

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]:-$0}")" && pwd)"
REPO_ROOT_DEFAULT="$HOME/Projects/jp-scripts"
# shellcheck source=../lib/log.sh disable=SC1091
. "$SCRIPT_DIR/../lib/log.sh"
# shellcheck source=../lib/config.sh disable=SC1091
. "$SCRIPT_DIR/../lib/config.sh"
# shellcheck source=../lib/deps.sh disable=SC1091
. "$SCRIPT_DIR/../lib/deps.sh"

while [ "$#" -gt 0 ]; do
  case "$1" in
    --apply)
      APPLY=true
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      printf 'Error: unknown option: %s\n' "$1" >&2
      usage >&2
      exit 1
      ;;
  esac
  shift
done

REPO_ROOT="$REPO_ROOT_DEFAULT"
BIN_DIR="$REPO_ROOT/bin"
ZSHRC="${ZDOTDIR:-$HOME}/.zshrc"
NOTES_DIR="$(jp_config_get notes_dir "$HOME/Notes/quick-notes" JP_NOTES_DIR)"
WORK_DIR="${JP_WORK_DIR:-"$HOME/.config/jp-work.d"}"

log_info "== jp-bootstrap"
log_info "Repo root:   $REPO_ROOT"
log_info "Bin dir:     $BIN_DIR"
log_info "Zsh config:  $ZSHRC"
log_info "Notes dir:   $NOTES_DIR"
log_info "Work dir:    $WORK_DIR"
log_info "Mode:        $([ "$APPLY" = true ] && printf 'APPLY' || printf 'DRY-RUN')"
echo

# 1. Check repo
if [ -d "$REPO_ROOT" ]; then
  log_info "Repo: OK – directory exists."
else
  log_warn "Repo: expected $REPO_ROOT but directory does not exist."
fi
echo

# 2. PATH check for jp-scripts/bin
PATH_OK=false
case ":$PATH:" in
  *":$BIN_DIR:"*) PATH_OK=true ;;
esac

if [ "$PATH_OK" = true ]; then
  log_info "PATH: OK – $BIN_DIR is already on PATH."
else
  log_warn "PATH: MISSING – $BIN_DIR is not currently on PATH."
  echo "      Expected an export in $ZSHRC similar to:"
  echo "        export PATH=\"\$HOME/Projects/jp-scripts/bin:\$PATH\""
  if [ "$APPLY" = true ]; then
    echo
    if [ ! -f "$ZSHRC" ]; then
      log_info "Creating $ZSHRC"
      printf '# ~/.zshrc created by jp-bootstrap\n' >> "$ZSHRC"
    fi
    if grep -q 'Projects/jp-scripts/bin' "$ZSHRC"; then
      log_info "PATH: A jp-scripts PATH line already exists in $ZSHRC; not modifying."
    else
      log_info "PATH: Adding jp-scripts PATH export to $ZSHRC"
      {
        printf '\n# jp-scripts: add custom commands to PATH\n'
        printf "export PATH=\"\$HOME/Projects/jp-scripts/bin:\$PATH\"\n"
      } >> "$ZSHRC"
    fi
  else
    echo "      (dry-run) No changes made."
  fi
fi
echo

# 3. Ensure notes directory
if [ -d "$NOTES_DIR" ]; then
  log_info "Notes: OK – directory exists at $NOTES_DIR"
else
  log_warn "Notes: MISSING – $NOTES_DIR does not exist."
  if [ "$APPLY" = true ]; then
    log_info "Notes: Creating directory."
    log_run mkdir -p "$NOTES_DIR"
  else
    echo "Notes: (dry-run) Would create: mkdir -p \"$NOTES_DIR\""
  fi
fi
echo

# 4. Ensure workspaces directory
if [ -d "$WORK_DIR" ]; then
  log_info "Workspaces: OK – directory exists at $WORK_DIR"
else
  log_warn "Workspaces: MISSING – $WORK_DIR does not exist."
  if [ "$APPLY" = true ]; then
    log_info "Workspaces: Creating directory."
    log_run mkdir -p "$WORK_DIR"
  else
    echo "Workspaces: (dry-run) Would create: mkdir -p \"$WORK_DIR\""
  fi
fi
echo

# 5. Run health checks (jp-lint + jpdoctor)
if command -v jp-check >/dev/null 2>&1; then
  log_info "Health: Running jp-check (jp-lint + jpdoctor)..."
  jp-check || true
else
  if command -v jp-lint >/dev/null 2>&1; then
    log_info "Health: Running jp-lint..."
    jp-lint || true
  else
    log_warn "Health: jp-lint not found on PATH."
  fi
  if command -v jpdoctor >/dev/null 2>&1; then
    echo
    log_info "Health: Running jpdoctor..."
    jpdoctor || true
  else
    log_warn "Health: jpdoctor not found on PATH."
  fi
fi

echo
log_info "jp-bootstrap: done."
echo "If PATH was updated, restart your shell or run: source \"$ZSHRC\""
