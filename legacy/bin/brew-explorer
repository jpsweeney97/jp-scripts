#!/usr/bin/env bash
set -euo pipefail

# Name: brew-explorer
# Category: system
# Description: Explore Homebrew formulas and casks with fzf, viewing info for a selection.
# Usage:
#   brew-explorer          # interactive list of installed formulas/casks
#
# Notes:
#   - Marks outdated items.
#   - After selection, prints "brew info <name>".

usage() {
  sed -n '4,40p' "$0" | sed 's/^# \?//'
}

case "${1-}" in
  -h|--help)
    usage
    exit 0
    ;;
esac

if ! command -v brew >/dev/null 2>&1; then
  printf 'Error: Homebrew (brew) not found.\n' >&2
  exit 1
fi

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]:-$0}")" && pwd)"
REPO_ROOT="$(cd -- "$SCRIPT_DIR/.." && pwd)"
# shellcheck source=../lib/fzf.sh disable=SC1091
. "$REPO_ROOT/lib/fzf.sh"

if ! fzf_require; then
  exit 1
fi

# Collect outdated packages
outdated_formulas="$(brew outdated --formula --quiet 2>/dev/null || true)"
outdated_casks="$(brew outdated --cask --quiet 2>/dev/null || true)"

is_outdated() {
  local name="$1"
  case " $outdated_formulas $outdated_casks " in
    *" $name "*) return 0 ;;
    *) return 1 ;;
  esac
}

items=""

# Formulas
while IFS= read -r name; do
  [ -z "$name" ] && continue
  status="ok"
  if is_outdated "$name"; then
    status="outdated"
  fi
  items+="formula | $name | $status"$'\n'
done < <(brew list --formula --quiet 2>/dev/null || true)

# Casks
while IFS= read -r name; do
  [ -z "$name" ] && continue
  status="ok"
  if is_outdated "$name"; then
    status="outdated"
  fi
  items+="cask    | $name | $status"$'\n'
done < <(brew list --cask --quiet 2>/dev/null || true)

if [ -z "$items" ]; then
  printf 'No Homebrew packages found.\n'
  exit 0
fi

fzf_set_common_opts "brew-explorer> " "Type | Name | Status (outdated marked)"

selection="$(
  printf '%s' "$items" \
    | fzf "${FZF_COMMON_OPTS[@]}" \
          --delimiter='|' \
          --with-nth=1,2,3
)" || exit 0

pkg="$(printf '%s\n' "$selection" | cut -d'|' -f2 | sed 's/^ *//; s/ *$//')"

if [ -z "$pkg" ]; then
  printf 'No selection.\n' >&2
  exit 1
fi

printf '=== brew info %s ===\n\n' "$pkg"
brew info "$pkg"
