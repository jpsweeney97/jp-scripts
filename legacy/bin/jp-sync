#!/usr/bin/env bash
set -euo pipefail

# Name: jp-sync
# Category: meta
# Description: Keep jp-scripts healthy: git status, lint/doctor/smoke, optional snapshot.
# Usage:
#   jp-sync             # status + jp-lint + jpdoctor + jp-smoke
#   jp-sync --fast      # skip jp-smoke
#   jp-sync --push      # push current branch after checks
#   jp-sync snap        # create a zip snapshot into ~/Backups/jp-scripts (configurable)
#   jp-sync pull        # git pull --rebase
#   Env: JP_SYNC_REPO to override repo path; JP_SYNC_SNAP_DIR for snapshot dir

usage() {
  sed -n '4,80p' "$0" | sed 's/^# \?//'
}

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]:-$0}")" && pwd)"
REPO_ROOT_DEFAULT="$(cd -- "$SCRIPT_DIR/.." && pwd)"
# shellcheck source=../lib/log.sh disable=SC1091
. "$REPO_ROOT_DEFAULT/lib/log.sh"
# shellcheck source=../lib/config.sh disable=SC1091
. "$REPO_ROOT_DEFAULT/lib/config.sh"
# shellcheck source=../lib/deps.sh disable=SC1091
. "$REPO_ROOT_DEFAULT/lib/deps.sh"
# shellcheck source=../lib/git.sh disable=SC1091
. "$REPO_ROOT_DEFAULT/lib/git.sh"

REPO_ROOT="${JP_SYNC_REPO:-$REPO_ROOT_DEFAULT}"

MODE="default"
FAST=0
DO_PUSH=0

args=("$@")
if [ "${1-}" = "snap" ] || [ "${1-}" = "pull" ]; then
  MODE="$1"
  args=("${@:2}")
fi

while [ "${#args[@]}" -gt 0 ]; do
  case "${args[0]}" in
    --fast)
      FAST=1
      args=("${args[@]:1}")
      ;;
    --push)
      DO_PUSH=1
      args=("${args[@]:1}")
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      log_fatal "Unknown option: ${args[0]}"
      ;;
  esac
done

run_step() {
  local name="$1"
  shift
  if [ "${JP_SMOKE:-0}" -eq 1 ] && { [ "$name" = "jp-lint" ] || [ "$name" = "jpdoctor" ]; }; then
    log_warn "Skipping $name (JP_SMOKE)"
    summary+=("$name:skipped")
    return 0
  fi
  log_info "== $name"
  if "$@"; then
    log_info "$name: ok"
    return 0
  else
    log_error "$name: failed"
    return 1
  fi
}

case "$MODE" in
  pull)
    deps_require git git || exit 1
    if [ ! -d "$REPO_ROOT/.git" ]; then
      log_fatal "Not a git repo: $REPO_ROOT (override with JP_SYNC_REPO)"
    fi
    log_run git -C "$REPO_ROOT" pull --rebase
    exit 0
    ;;

  snap)
    deps_require cleanzip zip "zip (cleanzip)" || exit 1
    ts="$(date +%Y-%m-%d__%H-%M-%S)"
  snap_dir="${JP_SYNC_SNAP_DIR:-$HOME/Backups/jp-scripts}"
  mkdir -p "$snap_dir"
  output_path="$snap_dir/${ts}__jp-scripts.zip"
  log_info "Creating snapshot at $output_path"
  log_info "Excludes: .git, build/cache dirs, .* swaps, logs, *.tmp, .env* (unless --include-env)"
  log_run cleanzip --force -o "$output_path" "$REPO_ROOT"
  log_info "Snapshot written to $output_path"
  exit 0
  ;;
esac

# Default mode
deps_require git git || exit 1
cd "$REPO_ROOT"

log_info "Repo: $REPO_ROOT"
log_info "Status:"
git status -sb --ignored || true

failures=0
declare -a summary=()

if run_step "jp-lint" jp-lint; then summary+=("jp-lint:ok"); else failures=$((failures + 1)); summary+=("jp-lint:fail"); fi
if run_step "jpdoctor" jpdoctor; then summary+=("jpdoctor:ok"); else failures=$((failures + 1)); summary+=("jpdoctor:fail"); fi
if [ "$FAST" -eq 0 ] && [ "${JP_SYNC_SKIP_SMOKE:-0}" -eq 0 ]; then
  if run_step "jp-smoke" jp-smoke; then summary+=("jp-smoke:ok"); else failures=$((failures + 1)); summary+=("jp-smoke:fail"); fi
else
  log_warn "Skipping jp-smoke (--fast)"
  summary+=("jp-smoke:skipped")
fi

if [ "$DO_PUSH" -eq 1 ]; then
  deps_require git git || exit 1
  current_branch="$(git_current_branch)"
  log_info "Pushing branch $current_branch"
  if log_run git push; then
    summary+=("git push:ok")
  else
    failures=$((failures + 1))
    summary+=("git push:fail")
  fi
fi

log_info "Summary:"
printf '  %s\n' "${summary[@]}"

if [ "$failures" -gt 0 ]; then
  log_warn "jp-sync completed with $failures failure(s)."
  exit 1
fi

log_info "jp-sync completed successfully."
