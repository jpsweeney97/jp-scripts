#!/usr/bin/env bash
set -euo pipefail

# Name: ssh-open
# Category: net
# Description: Fuzzy-launch SSH connections from ~/.ssh/config using fzf.
# Usage:
#   ssh-open          # pick a host from ~/.ssh/config and ssh into it
#
# Notes:
#   - Skips wildcard Host patterns like "*".
#   - Preview shows the relevant config block.

usage() {
  sed -n '4,40p' "$0" | sed 's/^# \?//'
}

case "${1-}" in
  -h|--help)
    usage
    exit 0
    ;;
esac

if ! command -v ssh >/dev/null 2>&1; then
  printf 'Error: ssh not found.\n' >&2
  exit 1
fi

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]:-$0}")" && pwd)"
REPO_ROOT="$(cd -- "$SCRIPT_DIR/.." && pwd)"
# shellcheck source=../lib/fzf.sh disable=SC1091
. "$REPO_ROOT/lib/fzf.sh"

if ! fzf_require; then
  exit 1
fi

SSH_CONFIG="${SSH_CONFIG:-"$HOME/.ssh/config"}"

if [ ! -f "$SSH_CONFIG" ]; then
  printf 'Error: SSH config not found at %s\n' "$SSH_CONFIG" >&2
  exit 1
fi

# Extract simple hostnames (single token, no wildcards)
mapfile -t hosts < <(
  awk '/^Host[[:space:]]+/ {
          for (i = 2; i <= NF; i++) {
              if ($i !~ /[*?]/) print $i;
          }
       }' "$SSH_CONFIG" | LC_ALL=C sort -u
)

if [ "${#hosts[@]}" -eq 0 ]; then
  printf 'ssh-open: no simple Host entries found in %s\n' "$SSH_CONFIG" >&2
  exit 0
fi

menu=""
for h in "${hosts[@]}"; do
  menu+="$h"$'\n'
done

# shellcheck disable=SC2016  # fzf preview: {} and $host are expanded when the preview runs, not here.
preview_cmd='host=$(printf "%s" {}); awk -v h="$host" "
  /^Host[[:space:]]+/ {
    if (block) exit;
    for (i = 2; i <= NF; i++) if (\$i == h) {block=1}
  }
  block {print}
" '"$SSH_CONFIG"' | sed "s/^/    /"'

fzf_set_common_opts "ssh-open> " "Select SSH host from $SSH_CONFIG"
fzf_add_preview "$preview_cmd" "right,60%,border-left"

selection="$(
  printf '%s' "$menu" \
    | fzf "${FZF_COMMON_OPTS[@]}"
)" || exit 0

host="$selection"
[ -z "$host" ] && exit 0

printf 'Connecting to %s...\n' "$host"
ssh "$host"
