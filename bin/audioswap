#!/usr/bin/env bash
set -euo pipefail

# Name: audioswap
# Category: macos
# Description: Interactive audio output device switcher using SwitchAudioSource + fzf.
# Usage:
#   audioswap              # pick from outputs via fzf
#   audioswap "Device Name"  # switch directly by name

if ! command -v SwitchAudioSource >/dev/null 2>&1; then
  printf 'Error: audioswap requires switchaudio-osx (SwitchAudioSource).\n' >&2
  printf 'Install via: brew install switchaudio-osx\n' >&2
  exit 1
fi

if [ "$#" -gt 0 ]; then
  device="$*"
  printf 'Setting output audio device to: %s\n' "$device"
  SwitchAudioSource -t output -s "$device"
  exit $?
fi

if ! command -v fzf >/dev/null 2>&1; then
  printf 'Error: audioswap interactive mode requires fzf.\n' >&2
  exit 1
fi

current="$(SwitchAudioSource -t output -c 2>/dev/null || true)"
devices="$(SwitchAudioSource -t output -a 2>/dev/null || true)"

if [ -z "$devices" ]; then
  printf 'No output devices found.\n' >&2
  exit 1
fi

selection="$(
  printf '%s\n' "$devices" \
    | sed "s/^/${current} | /" \
    | sed "s/^${current} |/${current:+*}|/" \
    | fzf --with-nth=2.. \
          --header="Current output: ${current:-unknown} (marked with *)" \
          --prompt="audioswap> "
)" || exit 0

# selection looks like "*|Device Name" or " |Device Name"
device_name="$(printf '%s\n' "$selection" | cut -d'|' -f2- | sed 's/^ *//')"

if [ -z "$device_name" ]; then
  printf 'No device selected.\n' >&2
  exit 1
fi

printf 'Setting output audio device to: %s\n' "$device_name"
SwitchAudioSource -t output -s "$device_name"
