#!/usr/bin/env bash
set -euo pipefail

# Name: audioswap
# Category: macos
# Description: Interactive audio output device switcher using SwitchAudioSource + fzf.
# Usage:
#   audioswap              # pick from outputs via fzf
#   audioswap "Device Name"  # switch directly by name

usage() {
  sed -n '4,40p' "$0" | sed 's/^# \?//'
}

case "${1-}" in
  -h|--help)
    usage
    exit 0
    ;;
esac

if ! command -v SwitchAudioSource >/dev/null 2>&1; then
  printf 'Error: audioswap requires switchaudio-osx (SwitchAudioSource).\n' >&2
  printf 'Install via: brew install switchaudio-osx\n' >&2
  exit 1
fi

if [ "$#" -gt 0 ]; then
  device="$*"
  printf 'Setting output audio device to: %s\n' "$device"
  SwitchAudioSource -t output -s "$device"
  exit $?
fi

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]:-$0}")" && pwd)"
REPO_ROOT="$(cd -- "$SCRIPT_DIR/.." && pwd)"
# shellcheck source=../lib/fzf.sh disable=SC1091
. "$REPO_ROOT/lib/fzf.sh"

if ! fzf_require; then
  exit 1
fi

current="$(SwitchAudioSource -t output -c 2>/dev/null || true)"
devices="$(SwitchAudioSource -t output -a 2>/dev/null || true)"

if [ -z "$devices" ]; then
  printf 'No output devices found.\n' >&2
  exit 1
fi

fzf_set_common_opts "audioswap> " "Current output: ${current:-unknown} (marked with *)"

selection="$(
  printf '%s\n' "$devices" \
    | sed "s/^/${current} | /" \
    | sed "s/^${current} |/${current:+*}|/" \
    | fzf "${FZF_COMMON_OPTS[@]}" \
          --with-nth=2.. \
          --header="Current output: ${current:-unknown} (marked with *)" \
          --prompt="audioswap> "
)" || exit 0

# selection looks like "*|Device Name" or " |Device Name"
device_name="$(printf '%s\n' "$selection" | cut -d'|' -f2- | sed 's/^ *//')"

if [ -z "$device_name" ]; then
  printf 'No device selected.\n' >&2
  exit 1
fi

printf 'Setting output audio device to: %s\n' "$device_name"
SwitchAudioSource -t output -s "$device_name"
