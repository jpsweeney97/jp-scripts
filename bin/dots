#!/usr/bin/env bash
set -euo pipefail

# Name: dots
# Category: config
# Description: Friendly wrapper around stow for managing dotfiles.
# Usage:
#   dots                 # list available dotfile packages
#   dots list            # same as above
#   dots apply <pkg...>  # stow packages into $HOME
#   dots dry-run <pkg...># show what would be linked (stow -nv)
#
# Env:
#   DOTFILES_ROOT   Root directory containing stow packages (default: $HOME/dotfiles)

if ! command -v stow >/dev/null 2>&1; then
  printf 'Error: dots requires stow. Install via: brew install stow\n' >&2
  exit 1
fi

DOTFILES_ROOT="${DOTFILES_ROOT:-"$HOME/dotfiles"}"

if [ ! -d "$DOTFILES_ROOT" ]; then
  printf 'Dotfiles root does not exist: %s\n' "$DOTFILES_ROOT" >&2
  printf 'Create it and add package dirs, e.g. %s/zsh, %s/git\n' "$DOTFILES_ROOT" "$DOTFILES_ROOT"
  exit 1
fi

list_pkgs() {
  cd "$DOTFILES_ROOT"
  pkgs=()
  while IFS= read -r d; do
    pkgs+=("$(basename "$d")")
  done < <(find . -mindepth 1 -maxdepth 1 -type d | sort)

  if [ "${#pkgs[@]}" -eq 0 ]; then
    printf 'No stow packages found under %s\n' "$DOTFILES_ROOT"
    return
  fi

  printf '%-16s %s\n' "Package" "Path"
  printf '%s\n' "---------------------------------------------"
  for p in "${pkgs[@]}"; do
    printf '%-16s %s/%s\n' "$p" "$DOTFILES_ROOT" "$p"
  done
}

if [ "$#" -eq 0 ] || [ "$1" = "list" ]; then
  list_pkgs
  exit 0
fi

mode="$1"
shift

if [ "$mode" != "apply" ] && [ "$mode" != "dry-run" ]; then
  printf 'Usage:\n' >&2
  printf '  dots                 # list packages\n' >&2
  printf '  dots apply <pkg...>  # stow into $HOME\n' >&2
  printf '  dots dry-run <pkg...># preview links\n' >&2
  exit 1
fi

if [ "$#" -eq 0 ]; then
  printf 'Error: no packages specified.\n' >&2
  exit 1
fi

cd "$DOTFILES_ROOT"

stow_args=(-t "$HOME")
[ "$mode" = "dry-run" ] && stow_args+=(-nv) || stow_args+=(-v)

printf 'dots: %s packages %s into %s\n' \
  "$mode" "$*" "$HOME"

stow "${stow_args[@]}" "$@"
