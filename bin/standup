#!/usr/bin/env bash
set -euo pipefail

# Name: standup
# Category: meta
# Description: Summarize your recent git commits across repos for daily standup.
# Usage:
#   standup             # show commits from the last day under ~/Projects
#   standup --days 2    # show commits from the last 2 days
#   standup --root DIR  # scan a different root than ~/Projects
#
# Env:
#   STANDUP_ROOT        Override default root directory for repo scan.
#   STANDUP_MAX_DEPTH   Limit find depth when searching for repos (default 3).
#   STANDUP_EXCLUDES    Comma-separated globs to skip when scanning (e.g., node_modules,venv).

usage() {
  sed -n '4,40p' "$0" | sed 's/^# \?//'
}

case "${1-}" in
  -h|--help)
    usage
    exit 0
    ;;
esac

ROOT="${STANDUP_ROOT:-"$HOME/Projects"}"
MAX_DEPTH="${STANDUP_MAX_DEPTH:-3}"
EXCLUDES_RAW="${STANDUP_EXCLUDES:-}"
exclude_patterns=()
if [ -n "$EXCLUDES_RAW" ]; then
  IFS=',' read -r -a exclude_patterns <<< "$EXCLUDES_RAW"
fi
DAYS=1

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]:-$0}")" && pwd)"
REPO_ROOT="$(cd -- "$SCRIPT_DIR/.." && pwd)"
# shellcheck source=../lib/log.sh disable=SC1091
. "$REPO_ROOT/lib/log.sh"
# shellcheck source=../lib/config.sh disable=SC1091
. "$REPO_ROOT/lib/config.sh"
# shellcheck source=../lib/git.sh disable=SC1091
. "$REPO_ROOT/lib/git.sh"

while [ "$#" -gt 0 ]; do
  case "$1" in
    --days)
      if [ "${2-}" = "" ]; then
        printf 'Error: --days requires a number.\n' >&2
        exit 1
      fi
      DAYS="$2"
      shift 2
      ;;
    --root)
      if [ "${2-}" = "" ]; then
        printf 'Error: --root requires a directory.\n' >&2
        exit 1
      fi
      ROOT="$2"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    -*)
      printf 'Error: unknown option: %s\n' "$1" >&2
      usage >&2
      exit 1
      ;;
    *)
      printf 'Error: unexpected argument: %s\n' "$1" >&2
      usage >&2
      exit 1
      ;;
  esac
done

git_require || exit 1

if [ ! -d "$ROOT" ]; then
  log_fatal "Root directory does not exist: $ROOT"
fi

# Date math: BSD date (macOS) supports -v; fallback to GNU date.
if date -v-"${DAYS}"d +%Y-%m-%dT00:00:00 >/dev/null 2>&1; then
  SINCE="$(date -v-"${DAYS}"d +%Y-%m-%dT00:00:00)"
else
  SINCE="$(date -d "-${DAYS} days" +%Y-%m-%dT00:00:00)"
fi
UNTIL="$(date +%Y-%m-%dT23:59:59)"

# Try to get your name for author filter; optional.
AUTHOR_NAME="$(git config user.name 2>/dev/null || true)"

log_info "Standup window: $SINCE to $UNTIL ($DAYS day(s))"
log_info "Root: $ROOT (maxdepth $MAX_DEPTH)"
if [ "${#exclude_patterns[@]}" -gt 0 ]; then
  log_info "Excludes: ${EXCLUDES_RAW}"
fi
[ -n "$AUTHOR_NAME" ] && log_info "Author filter: $AUTHOR_NAME"
echo

# Find git repos under ROOT.
find_args=("$ROOT" -maxdepth "$MAX_DEPTH")
for pat in "${exclude_patterns[@]}"; do
  # Trim whitespace around patterns to avoid accidental spaces.
  pat="${pat#"${pat%%[![:space:]]*}"}"
  pat="${pat%"${pat##*[![:space:]]}"}"
  [ -z "$pat" ] && continue
  find_args+=(-not -path "*/$pat/*")
done
find_args+=(-type d -name '.git')
mapfile -t git_dirs < <(find "${find_args[@]}" 2>/dev/null | sort)

if [ "${#git_dirs[@]}" -eq 0 ]; then
  printf 'No git repositories found under %s\n' "$ROOT"
  exit 0
fi

had_output=false

for gdir in "${git_dirs[@]}"; do
  repo="${gdir%/.git}"
  [ ! -d "$repo" ] && continue

  if ! cd "$repo" >/dev/null 2>&1; then
    continue
  fi

  # Build git log command
  args=(log --since="$SINCE" --until="$UNTIL" --pretty='* %h %s')
  if [ -n "$AUTHOR_NAME" ]; then
    args+=(--author="$AUTHOR_NAME")
  fi

  log_output="$(git "${args[@]}" 2>/dev/null || true)"

  if [ -n "$log_output" ]; then
    had_output=true
    name="$(basename "$repo")"
    log_info "Repo: $name ($repo)"
    printf '%s\n\n' "$log_output"
  fi
done

if [ "$had_output" = false ]; then
  printf 'No matching commits found in the last %s day(s).\n' "$DAYS"
fi
