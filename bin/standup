#!/usr/bin/env bash
set -euo pipefail

# Name: standup
# Category: meta
# Description: Summarize your recent git commits across repos for daily standup.
# Usage:
#   standup             # show commits from the last day under ~/Projects
#   standup --days 2    # show commits from the last 2 days
#   standup --root DIR  # scan a different root than ~/Projects
#
# Env:
#   STANDUP_ROOT   Override default root directory for repo scan.

usage() {
  sed -n '4,40p' "$0" | sed 's/^# \?//'
}

case "${1-}" in
  -h|--help)
    usage
    exit 0
    ;;
esac

ROOT="${STANDUP_ROOT:-"$HOME/Projects"}"
DAYS=1

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]:-$0}")" && pwd)"
REPO_ROOT="$(cd -- "$SCRIPT_DIR/.." && pwd)"
# shellcheck source=../lib/git.sh disable=SC1091
. "$REPO_ROOT/lib/git.sh"

while [ "$#" -gt 0 ]; do
  case "$1" in
    --days)
      if [ "${2-}" = "" ]; then
        printf 'Error: --days requires a number.\n' >&2
        exit 1
      fi
      DAYS="$2"
      shift 2
      ;;
    --root)
      if [ "${2-}" = "" ]; then
        printf 'Error: --root requires a directory.\n' >&2
        exit 1
      fi
      ROOT="$2"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    -*)
      printf 'Error: unknown option: %s\n' "$1" >&2
      usage >&2
      exit 1
      ;;
    *)
      printf 'Error: unexpected argument: %s\n' "$1" >&2
      usage >&2
      exit 1
      ;;
  esac
done

if ! git_require; then
  exit 1
fi

if [ ! -d "$ROOT" ]; then
  printf 'Error: root directory does not exist: %s\n' "$ROOT" >&2
  exit 1
fi

# Date math: BSD date (macOS) supports -v; DAYS is positive integer.
SINCE="$(date -v-"${DAYS}"d +%Y-%m-%dT00:00:00)"
UNTIL="$(date +%Y-%m-%dT23:59:59)"

# Try to get your name for author filter; optional.
AUTHOR_NAME="$(git config user.name 2>/dev/null || true)"

printf 'Standup window: %s to %s (%s day(s))\n' "$SINCE" "$UNTIL" "$DAYS"
printf 'Root: %s\n' "$ROOT"
[ -n "$AUTHOR_NAME" ] && printf 'Author filter: %s\n' "$AUTHOR_NAME"
printf '\n'

# Find git repos under ROOT (maxdepth 3 to keep it sane).
mapfile -t git_dirs < <(find "$ROOT" -maxdepth 3 -type d -name '.git' 2>/dev/null | sort)

if [ "${#git_dirs[@]}" -eq 0 ]; then
  printf 'No git repositories found under %s\n' "$ROOT"
  exit 0
fi

had_output=false

for gdir in "${git_dirs[@]}"; do
  repo="${gdir%/.git}"
  [ ! -d "$repo" ] && continue

  if ! cd "$repo" >/dev/null 2>&1; then
    continue
  fi

  # Build git log command
  args=(log --since="$SINCE" --until="$UNTIL" --pretty='* %h %s')
  if [ -n "$AUTHOR_NAME" ]; then
    args+=(--author="$AUTHOR_NAME")
  fi

  log_output="$(git "${args[@]}" 2>/dev/null || true)"

  if [ -n "$log_output" ]; then
    had_output=true
    name="$(basename "$repo")"
    printf 'Repo: %s (%s)\n' "$name" "$repo"
    printf '%s\n\n' "$log_output"
  fi
done

if [ "$had_output" = false ]; then
  printf 'No matching commits found in the last %s day(s).\n' "$DAYS"
fi
