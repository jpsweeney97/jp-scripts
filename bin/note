#!/usr/bin/env bash
set -euo pipefail

# Name: note
# Category: notes
# Description: Fast daily note capture/append in a date-stamped Markdown file.
# Usage:
#   note "Thought goes here"
#   echo "multi-line note" | note
#   note --edit        # open today's note in editor (code or $EDITOR)
#
# Env:
#   JP_NOTES_DIR   Base directory for notes (default: $HOME/Notes/quick-notes)

usage() {
  sed -n '4,40p' "$0" | sed 's/^# \?//'
}

case "${1-}" in
  -h|--help)
    usage
    exit 0
    ;;
esac

NOTES_DIR="${JP_NOTES_DIR:-"$HOME/Notes/quick-notes"}"
mkdir -p "$NOTES_DIR"

today="$(date +%Y-%m-%d)"
timestamp="$(date +%H:%M:%S)"
note_file="$NOTES_DIR/$today.md"

open_editor() {
  if command -v code >/dev/null 2>&1; then
    code "$note_file"
  elif [ -n "${EDITOR:-}" ]; then
    "$EDITOR" "$note_file"
  else
    nano "$note_file"
  fi
}

if [ "${1-}" = "--edit" ]; then
  touch "$note_file"
  open_editor
  exit 0
fi

# If stdin has data, read it as the note body
if ! [ -t 0 ]; then
  body="$(cat -)"
elif [ "$#" -gt 0 ]; then
  body="$*"
else
  # No args, no stdin -> just open today's file
  touch "$note_file"
  open_editor
  exit 0
fi

touch "$note_file"

{
  printf '## %s %s\n\n' "$today" "$timestamp"
  printf '%s\n\n' "$body"
} >> "$note_file"

printf 'Appended note to %s\n' "$note_file"
