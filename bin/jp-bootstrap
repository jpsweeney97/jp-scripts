#!/usr/bin/env bash
set -euo pipefail

# Name: jp-bootstrap
# Category: meta
# Description: Bootstrap jp-scripts on a fresh machine: configure PATH, create dirs, and run health checks.
# Usage:
#   jp-bootstrap            # dry-run: show what would be done
#   jp-bootstrap --apply    # make non-destructive changes (PATH line, dirs)
#
# Notes:
#   - Never runs arbitrary remote installers; only touches local files and runs jp-lint/jpdoctor.
#   - Intended to be run after cloning ~/Projects/jp-scripts on a new machine.

usage() {
  sed -n '4,40p' "$0" | sed 's/^# \?//'
}

APPLY=false

while [ "$#" -gt 0 ]; do
  case "$1" in
    --apply)
      APPLY=true
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      printf 'Error: unknown option: %s\n' "$1" >&2
      usage >&2
      exit 1
      ;;
  esac
  shift
done

REPO_ROOT="$HOME/Projects/jp-scripts"
BIN_DIR="$REPO_ROOT/bin"
ZSHRC="${ZDOTDIR:-$HOME}/.zshrc"
NOTES_DIR="${JP_NOTES_DIR:-"$HOME/Notes/quick-notes"}"
WORK_DIR="${JP_WORK_DIR:-"$HOME/.config/jp-work.d"}"

echo "== jp-bootstrap"
echo "Repo root:   $REPO_ROOT"
echo "Bin dir:     $BIN_DIR"
echo "Zsh config:  $ZSHRC"
echo "Notes dir:   $NOTES_DIR"
echo "Work dir:    $WORK_DIR"
echo "Mode:        $([ "$APPLY" = true ] && printf 'APPLY' || printf 'DRY-RUN')"
echo

# 1. Check repo
if [ -d "$REPO_ROOT" ]; then
  echo "Repo: OK – directory exists."
else
  printf 'Repo: WARNING – expected %s but directory does not exist.\n' "$REPO_ROOT" >&2
fi
echo

# 2. PATH check for jp-scripts/bin
PATH_OK=false
case ":$PATH:" in
  *":$BIN_DIR:"*) PATH_OK=true ;;
esac

if [ "$PATH_OK" = true ]; then
  echo "PATH: OK – $BIN_DIR is already on PATH."
else
  echo "PATH: MISSING – $BIN_DIR is not currently on PATH."
  echo "      Expected an export in $ZSHRC similar to:"
  echo "        export PATH=\"\$HOME/Projects/jp-scripts/bin:\$PATH\""
  if [ "$APPLY" = true ]; then
    echo
    if [ ! -f "$ZSHRC" ]; then
      echo "Creating $ZSHRC"
      printf '# ~/.zshrc created by jp-bootstrap\n' >> "$ZSHRC"
    fi
    if grep -q 'Projects/jp-scripts/bin' "$ZSHRC"; then
      echo "PATH: A jp-scripts PATH line already exists in $ZSHRC; not modifying."
    else
      echo "PATH: Adding jp-scripts PATH export to $ZSHRC"
      {
        printf '\n# jp-scripts: add custom commands to PATH\n'
        printf "export PATH=\"\$HOME/Projects/jp-scripts/bin:\$PATH\"\n"
      } >> "$ZSHRC"
    fi
  else
    echo "      (dry-run) No changes made."
  fi
fi
echo

# 3. Ensure notes directory
if [ -d "$NOTES_DIR" ]; then
  echo "Notes: OK – directory exists at $NOTES_DIR"
else
  echo "Notes: MISSING – $NOTES_DIR does not exist."
  if [ "$APPLY" = true ]; then
    echo "Notes: Creating directory."
    mkdir -p "$NOTES_DIR"
  else
    echo "Notes: (dry-run) Would create: mkdir -p \"$NOTES_DIR\""
  fi
fi
echo

# 4. Ensure workspaces directory
if [ -d "$WORK_DIR" ]; then
  echo "Workspaces: OK – directory exists at $WORK_DIR"
else
  echo "Workspaces: MISSING – $WORK_DIR does not exist."
  if [ "$APPLY" = true ]; then
    echo "Workspaces: Creating directory."
    mkdir -p "$WORK_DIR"
  else
    echo "Workspaces: (dry-run) Would create: mkdir -p \"$WORK_DIR\""
  fi
fi
echo

# 5. Run health checks (jp-lint + jpdoctor)
if command -v jp-check >/dev/null 2>&1; then
  echo "Health: Running jp-check (jp-lint + jpdoctor)..."
  jp-check || true
else
  if command -v jp-lint >/dev/null 2>&1; then
    echo "Health: Running jp-lint..."
    jp-lint || true
  else
    echo "Health: WARNING – jp-lint not found on PATH."
  fi
  if command -v jpdoctor >/dev/null 2>&1; then
    echo
    echo "Health: Running jpdoctor..."
    jpdoctor || true
  else
    echo "Health: WARNING – jpdoctor not found on PATH."
  fi
fi

echo
echo "jp-bootstrap: done."
echo "If PATH was updated, restart your shell or run: source \"$ZSHRC\""
