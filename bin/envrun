#!/usr/bin/env bash
set -euo pipefail

# Name: envrun
# Category: env
# Description: Run a command with environment variables loaded from a file (e.g. .env).
# Usage:
#   envrun [envfile] -- <command> [args...]
#   envrun --dry-run [envfile]
#
# Notes:
#   - Default env file is .env in the current directory.
#   - --dry-run prints which keys would be loaded, but does not run the command.
#   - For non-dry runs, envfile is sourced in a subshell (shell-compatible KEY=VALUE lines).

ENVFILE=""
DRY_RUN=false

while [ "$#" -gt 0 ]; do
  case "$1" in
    --dry-run)
      DRY_RUN=true
      shift
      ;;
    --)
      shift
      break
      ;;
    -h|--help)
      sed -n '4,40p' "$0"
      exit 0
      ;;
    -*)
      printf 'Error: unknown option: %s\n' "$1" >&2
      sed -n '4,40p' "$0" >&2
      exit 1
      ;;
    *)
      if [ -z "$ENVFILE" ]; then
        ENVFILE="$1"
        shift
      else
        printf 'Error: multiple envfile arguments provided.\n' >&2
        sed -n '4,40p' "$0" >&2
        exit 1
      fi
      ;;
  esac
done

if [ -z "$ENVFILE" ]; then
  ENVFILE=".env"
fi

if [ ! -f "$ENVFILE" ]; then
  printf 'Error: env file not found: %s\n' "$ENVFILE" >&2
  exit 1
fi

if [ "$DRY_RUN" = true ]; then
  printf 'envrun dry-run: env file %s\n' "$ENVFILE"
  printf 'Keys that would be loaded:\n\n'
  grep -E '^[A-Za-z_][A-Za-z0-9_]*=' "$ENVFILE" \
    | sed 's/=.*//' \
    | sed 's/^/  /'
  printf '\n'
  exit 0
fi

if [ "$#" -eq 0 ]; then
  printf 'Usage: envrun [envfile] -- <command> [args...]\n' >&2
  exit 1
fi

# Run the command in a subshell where the env file has been sourced.
# WARNING: this executes shell code from ENVFILE; use only for trusted local files.
(
  set -a
  # shellcheck disable=SC1090
  . "$ENVFILE"
  set +a
  exec "$@"
)
