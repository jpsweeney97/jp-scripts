#!/usr/bin/env bash
set -euo pipefail

# Name: process-kill
# Category: system
# Description: Interactive process picker+killer using ps + fzf.
# Usage:
#   process-kill           # select one or more processes to kill with SIGTERM
#   process-kill --force   # kill with SIGKILL
#
# Notes:
# - Multi-select enabled: use TAB in fzf to select many.
# - Protects against killing PID 1.

usage() {
  sed -n '4,40p' "$0" | sed 's/^# \?//'
}

case "${1-}" in
  -h|--help)
    usage
    exit 0
    ;;
esac

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]:-$0}")" && pwd)"
REPO_ROOT="$(cd -- "$SCRIPT_DIR/.." && pwd)"
# shellcheck source=../lib/log.sh disable=SC1091
. "$REPO_ROOT/lib/log.sh"
# shellcheck source=../lib/deps.sh disable=SC1091
. "$REPO_ROOT/lib/deps.sh"
# shellcheck source=../lib/fzf.sh disable=SC1091
. "$REPO_ROOT/lib/fzf.sh"

if ! command -v ps >/dev/null 2>&1; then
  log_fatal "ps command not found; cannot list processes."
fi
fzf_require || exit 1

SIG="TERM"
if [ "${1-}" = "--force" ]; then
  SIG="KILL"
fi

ps_output="$(ps -axo pid,ppid,stat,%cpu,%mem,command | sed 1d)" || true
if [ -z "$ps_output" ]; then
  log_warn "No processes found."
  exit 0
fi

fzf_set_common_opts "psfz> " "Select process(es) to kill with SIG${SIG}. TAB=multi, ENTER=confirm."

selection="$(
  printf '%s\n' "$ps_output" \
    | fzf -m "${FZF_COMMON_OPTS[@]}"
)" || exit 0

pids=()
while IFS= read -r line; do
  [ -z "$line" ] && continue
  pid="$(printf '%s\n' "$line" | awk '{print $1}')"
  [ "$pid" = "1" ] && continue  # never kill PID 1
  pids+=("$pid")
done <<< "$selection"

if [ "${#pids[@]}" -eq 0 ]; then
  printf 'No valid PIDs selected.\n'
  exit 0
fi

log_info "About to send SIG${SIG} to PIDs: ${pids[*]}"
printf 'Proceed? [y/N]: '
read -r reply
case "$reply" in
  y|Y|yes|YES) ;;
  *) log_warn "Aborted."; exit 0 ;;
esac

for pid in "${pids[@]}"; do
  log_info "killing PID $pid with SIG$SIG"
  kill -s "$SIG" "$pid" || log_warn "failed to kill PID $pid"
done
