#!/usr/bin/env bash
set -euo pipefail

# Name: note-search
# Category: notes
# Description: Fzf search across daily Markdown notes and jump to a match.
# Usage:
#   note-search <pattern>
#   note-search              # prompt for pattern
#   note-search --today      # search only today's note
#   note-search --tag focus  # search for #focus
#   note-search --print      # print file:line instead of opening editor
#   note-search --append "text"  # append text to the selected note after selecting
#   note-search --create     # if no matches, create/open today's note

usage() {
  sed -n '4,80p' "$0" | sed 's/^# \?//'
}

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]:-$0}")" && pwd)"
REPO_ROOT="$(cd -- "$SCRIPT_DIR/.." && pwd)"
# shellcheck source=../lib/config.sh disable=SC1091
. "$REPO_ROOT/lib/config.sh"
# shellcheck source=../lib/log.sh disable=SC1091
. "$REPO_ROOT/lib/log.sh"
# shellcheck source=../lib/deps.sh disable=SC1091
. "$REPO_ROOT/lib/deps.sh"
# shellcheck source=../lib/fzf.sh disable=SC1091
. "$REPO_ROOT/lib/fzf.sh"

PATTERN=""
NOTES_DIR="$(jp_config_get notes_dir "$HOME/Notes/quick-notes" JP_NOTES_DIR)"
ONLY_FILE=""
MODE="open"
APPEND_TEXT=""
CREATE_ON_MISS=0

append_to_note() {
  local file="$1"
  local text="$2"
  [ -z "$text" ] && return 0
  {
    printf '\n## %s %s\n\n' "$(date +%Y-%m-%d)" "$(date +%H:%M:%S)"
    printf '%s\n' "$text"
    printf '\n'
  } >> "$file"
  log_info "Appended text to $file"
}

while [ "$#" -gt 0 ]; do
  case "$1" in
    --today)
      ONLY_FILE="$(date +%Y-%m-%d).md"
      shift
      ;;
    --yesterday)
      if date -v-1d '+%Y-%m-%d' >/dev/null 2>&1; then
        ONLY_FILE="$(date -v-1d +%Y-%m-%d).md"
      else
        ONLY_FILE="$(date -d 'yesterday' +%Y-%m-%d).md"
      fi
      shift
      ;;
    --tag)
      [ -n "${2-}" ] || log_fatal "--tag requires a value"
      PATTERN="#${2}"
      shift 2
      ;;
    --dir)
      [ -n "${2-}" ] || log_fatal "--dir requires a path"
      NOTES_DIR="$2"
      shift 2
      ;;
    --print)
      MODE="print"
      shift
      ;;
    --append)
      [ -n "${2-}" ] || log_fatal "--append requires text"
      APPEND_TEXT="$2"
      shift 2
      ;;
    --create)
      CREATE_ON_MISS=1
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      if [ -z "$PATTERN" ]; then
        PATTERN="$1"
        shift
      else
        log_fatal "Unexpected argument: $1"
      fi
      ;;
  esac
done

if [ -z "$PATTERN" ] && [ "$CREATE_ON_MISS" -eq 1 ]; then
  target_file="$NOTES_DIR/${ONLY_FILE:-$(date +%Y-%m-%d).md}"
  touch "$target_file"
  log_info "Created $target_file (no pattern provided; --create)"
  exit 0
fi

[ -d "$NOTES_DIR" ] || mkdir -p "$NOTES_DIR"

if [ -z "$PATTERN" ]; then
  printf 'Pattern: '
  read -r PATTERN
fi

# Allow piping text for append if requested without argument
if [ -t 0 ] || [ -n "$APPEND_TEXT" ]; then
  :
else
  APPEND_TEXT="$(cat -)"
fi

if [ -z "$PATTERN" ]; then
  log_warn "No pattern provided."
  exit 0
fi

deps_require rg ripgrep || exit 1
deps_require fzf fzf || exit 1
deps_warn_missing bat bat "preview highlighting" || true

rg_args=(-n --no-heading --glob '*.md' "$PATTERN" "$NOTES_DIR")
if [ -n "$ONLY_FILE" ]; then
  rg_args=(-n --no-heading --glob "$ONLY_FILE" "$PATTERN" "$NOTES_DIR")
fi

matches="$(rg "${rg_args[@]}" || true)"
if [ -z "$matches" ]; then
  if [ "$CREATE_ON_MISS" -eq 1 ]; then
    today_file="$NOTES_DIR/$(date +%Y-%m-%d).md"
    touch "$today_file"
    log_info "No matches; created/opening $today_file"
    if command -v code >/dev/null 2>&1; then
      code "$today_file"
    elif [ -n "${EDITOR:-}" ]; then
      $EDITOR "$today_file"
    fi
  else
    log_warn "No matches."
  fi
  exit 0
fi

header="$(fzf_join_header "Notes: $NOTES_DIR" "Pattern: $PATTERN")"
fzf_set_common_opts "notes> " "$header" "right,70%,border-left"
fzf_add_default_preview 200 "right,70%,border-left"

selection="$(
  printf '%s\n' "$matches" \
    | fzf "${FZF_COMMON_OPTS[@]}"
)" || exit 0

file="$(printf '%s' "$selection" | cut -d':' -f1)"
line="$(printf '%s' "$selection" | cut -d':' -f2)"

case "$MODE" in
  print)
    printf '%s:%s\n' "$file" "$line"
    ;;
  open)
    if command -v code >/dev/null 2>&1; then
      code -g "$file:$line"
    elif [ -n "${EDITOR:-}" ]; then
      $EDITOR "+$line" "$file"
    else
      sed -n "${line}p" "$file"
    fi
    ;;
esac

append_to_note "$file" "$APPEND_TEXT"
