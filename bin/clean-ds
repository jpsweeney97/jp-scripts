#!/usr/bin/env bash
set -euo pipefail

# Name: clean-ds
# Category: files
# Description: Safely remove .DS_Store and AppleDouble (._*) files under a directory.
# Usage:
#   clean-ds              # dry-run for current directory
#   clean-ds <path>       # dry-run for given directory
#   clean-ds --force      # actually delete in current directory
#   clean-ds --force <path>
#
# Notes:
# - Dry-run by default: prints what WOULD be removed.
# - Use --force to actually delete.
# - Refuses to run on root (/) as a safety guard.

force=false
target_dir="."

# Parse args
for arg in "$@"; do
  case "$arg" in
    --force)
      force=true
      ;;
    *)
      if [ "$target_dir" = "." ]; then
        target_dir="$arg"
      else
        printf 'Error: multiple paths provided. Usage: clean-ds [--force] [path]\n' >&2
        exit 1
      fi
      ;;
  esac
done

# Resolve absolute path and basic safety checks
if [ ! -d "$target_dir" ]; then
  printf 'Error: "%s" is not a directory or does not exist.\n' "$target_dir" >&2
  exit 1
fi

TARGET_ABS="$(cd -- "$target_dir" && pwd)"

if [ "$TARGET_ABS" = "/" ]; then
  printf 'Refusing to operate on root directory (/). Pick a safer path.\n' >&2
  exit 1
fi

if [ "$force" = false ]; then
  printf 'clean-ds: DRY RUN (no deletions performed)\n' >&2
  printf 'Target directory: %s\n' "$TARGET_ABS" >&2
  printf 'Would remove the following files (if any):\n\n'

  # List matching files
  if ! find "$TARGET_ABS" \( -name '.DS_Store' -o -name '._*' \) -print; then
    printf '\n(No matching files found or find encountered an error.)\n' >&2
  fi

  printf '\nTo actually delete these files, re-run with --force.\n' >&2
else
  printf 'clean-ds: FORCE MODE (deleting files)\n' >&2
  printf 'Target directory: %s\n' "$TARGET_ABS" >&2
  printf 'Deleting .DS_Store and AppleDouble (._*) files...\n\n' >&2

  # Print then delete
  # The -print happens before -delete so you see what was removed.
  if ! find "$TARGET_ABS" \( -name '.DS_Store' -o -name '._*' \) -print -delete; then
    printf '\nWarning: find encountered an error.\n' >&2
  fi

  printf '\nDone.\n' >&2
fi
