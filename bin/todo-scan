#!/usr/bin/env bash
set -euo pipefail

# Name: todo-scan
# Category: search
# Description: Scan for TODO/FIXME/HACK/BUG in the current project and jump to matches.
# Usage:
#   todo-scan                 # interactively pick a TODO-like match
#   todo-scan "PAYMENTS"      # extra content/path filter
#   todo-scan --since HEAD~5  # limit to files changed since commit
#   todo-scan --path "src/**" # limit by glob

usage() {
  sed -n '4,80p' "$0" | sed 's/^# \?//'
}

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]:-$0}")" && pwd)"
REPO_ROOT="$(cd -- "$SCRIPT_DIR/.." && pwd)"
# shellcheck source=../lib/log.sh disable=SC1091
. "$REPO_ROOT/lib/log.sh"
# shellcheck source=../lib/deps.sh disable=SC1091
. "$REPO_ROOT/lib/deps.sh"
# shellcheck source=../lib/config.sh disable=SC1091
. "$REPO_ROOT/lib/config.sh"
# shellcheck source=../lib/fzf.sh disable=SC1091
. "$REPO_ROOT/lib/fzf.sh"
# shellcheck source=../lib/git.sh disable=SC1091
. "$REPO_ROOT/lib/git.sh"

PATTERN='TODO|FIXME|HACK|BUG'
PATH_GLOB=""
SINCE_COMMIT=""
CONTEXT=2
MODE="open"
EXTRA_FILTER=""

open_at_line() {
  local file="$1"
  local line="$2"

  if command -v code >/dev/null 2>&1; then
    code -g "$file:$line"
  elif [ -n "${EDITOR:-}" ]; then
    $EDITOR "+$line" "$file"
  else
    log_warn "No editor found; printing match."
    sed -n "${line}p" "$file"
  fi
}

while [ "$#" -gt 0 ]; do
  case "$1" in
    --types)
      [ -n "${2-}" ] || log_fatal "--types requires a comma-separated list"
      PATTERN="${2//,/|}"
      shift 2
      ;;
    --path)
      [ -n "${2-}" ] || log_fatal "--path requires a glob"
      PATH_GLOB="$2"
      shift 2
      ;;
    --since)
      [ -n "${2-}" ] || log_fatal "--since requires a commit-ish"
      SINCE_COMMIT="$2"
      shift 2
      ;;
    --context)
      [ -n "${2-}" ] || log_fatal "--context requires a number"
      CONTEXT="$2"
      shift 2
      ;;
    --print)
      MODE="print"
      shift
      ;;
    --open)
      MODE="open"
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      if [ -z "$EXTRA_FILTER" ]; then
        EXTRA_FILTER="$1"
        shift
      else
        log_fatal "Unknown argument: $1"
      fi
      ;;
  esac
done

deps_require rg ripgrep || exit 1
deps_require fzf fzf || exit 1
deps_warn_missing bat bat "preview highlighting" || true

root="."
if git_is_repo; then
  root="$(git_repo_root)"
else
  root="$(pwd)"
fi

rg_args=(-n --hidden --glob '!.git' --context "$CONTEXT" "$PATTERN")
if [ -n "$PATH_GLOB" ]; then
  rg_args+=(--glob "$PATH_GLOB")
fi

target_files=()
if [ -n "$SINCE_COMMIT" ]; then
  if ! git_is_repo; then
    log_fatal "--since requires a git repository"
  fi
  mapfile -t target_files < <(git diff --name-only "$SINCE_COMMIT"..HEAD --)
  if [ "${#target_files[@]}" -eq 0 ]; then
    log_warn "No files changed since $SINCE_COMMIT"
    exit 0
  fi
fi

search() {
  if [ "${#target_files[@]}" -gt 0 ]; then
    rg "${rg_args[@]}" -- "${target_files[@]}"
  else
    rg "${rg_args[@]}" -- "$root"
  fi
}

results="$(search || true)"
if [ -n "$EXTRA_FILTER" ]; then
  results="$(printf '%s\n' "$results" | rg --no-heading --fixed-strings --ignore-case "$EXTRA_FILTER" || true)"
fi

if [ -z "$results" ]; then
  log_warn "No matches found."
  exit 0
fi

preview_cmd="$(fzf_default_preview_cmd 200)"
header="$(fzf_join_header "Root: $root" "Pattern: $PATTERN" "Mode: $MODE")"
fzf_set_common_opts "todo> " "$header" "right,60%,border-left"
fzf_add_preview "$preview_cmd" "right,60%,border-left:+{2}-1"

if [ "${TODO_SCAN_NONINTERACTIVE:-0}" -eq 1 ]; then
  selection="$(printf '%s\n' "$results" | head -n 1)"
else
  selection="$(
    printf '%s\n' "$results" \
      | fzf "${FZF_COMMON_OPTS[@]}"
  )" || exit 0
fi

file="$(printf '%s' "$selection" | cut -d':' -f1)"
line="$(printf '%s' "$selection" | cut -d':' -f2)"

if [ "$MODE" = "print" ]; then
  printf '%s:%s\n' "$file" "$line"
  exit 0
fi

open_at_line "$file" "$line"
