#!/usr/bin/env bash
set -euo pipefail

# Name: ssh-open
# Category: net
# Description: Fuzzy-launch SSH connections from ~/.ssh/config using fzf.
# Usage:
#   ssh-open          # pick a host from ~/.ssh/config and ssh into it
#
# Notes:
#   - Skips wildcard Host patterns like "*".
#   - Preview shows the relevant config block.

if ! command -v ssh >/dev/null 2>&1; then
  printf 'Error: ssh not found.\n' >&2
  exit 1
fi

if ! command -v fzf >/dev/null 2>&1; then
  printf 'Error: ssh-open requires fzf. Install via: brew install fzf\n' >&2
  exit 1
fi

SSH_CONFIG="${SSH_CONFIG:-"$HOME/.ssh/config"}"

if [ ! -f "$SSH_CONFIG" ]; then
  printf 'Error: SSH config not found at %s\n' "$SSH_CONFIG" >&2
  exit 1
fi

# Extract simple hostnames (single token, no wildcards)
mapfile -t hosts < <(
  awk '/^Host[[:space:]]+/ {
          for (i = 2; i <= NF; i++) {
              if ($i !~ /[*?]/) print $i;
          }
       }' "$SSH_CONFIG" | LC_ALL=C sort -u
)

if [ "${#hosts[@]}" -eq 0 ]; then
  printf 'ssh-open: no simple Host entries found in %s\n' "$SSH_CONFIG" >&2
  exit 0
fi

menu=""
for h in "${hosts[@]}"; do
  menu+="$h"$'\n'
done

preview_cmd='host=$(printf "%s" {}); awk -v h="$host" "
  /^Host[[:space:]]+/ {
    if (block) exit;
    for (i = 2; i <= NF; i++) if (\$i == h) {block=1}
  }
  block {print}
" '"$SSH_CONFIG"' | sed "s/^/    /"'

selection="$(
  printf '%s' "$menu" \
    | fzf --ansi \
          --prompt='ssh-open> ' \
          --header="Select SSH host from $SSH_CONFIG" \
          --preview="$preview_cmd" \
          --preview-window=right,60%,border-left
)" || exit 0

host="$selection"
[ -z "$host" ] && exit 0

printf 'Connecting to %s...\n' "$host"
ssh "$host"
