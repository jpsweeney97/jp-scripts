#!/usr/bin/env bash
set -euo pipefail

# Name: snaprepo
# Category: git
# Description: Create a clean zip snapshot of the current git repo using cleanzip.
# Usage:
#   snaprepo             # snapshot current repo with default naming
#   snaprepo --dry-run   # show what cleanzip would do, but don't create zip
#   snaprepo --include-env   # include .env and key/cert files (default is exclude)
#   snaprepo --force     # overwrite existing zip if it exists
#
# Notes:
# - Must be run somewhere inside a git repository.
# - Uses cleanzip under the hood for excludes and naming.
# - Output zip is written next to the repo root.

usage() {
  sed -n '4,40p' "$0" | sed 's/^# \?//'
}

case "${1-}" in
  -h|--help)
    usage
    exit 0
    ;;
esac

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]:-$0}")" && pwd)"
REPO_ROOT="$(cd -- "$SCRIPT_DIR/.." && pwd)"
# shellcheck source=../lib/git.sh disable=SC1091
. "$REPO_ROOT/lib/git.sh"

if ! git_require_repo; then
  exit 1
fi

if ! command -v cleanzip >/dev/null 2>&1; then
  printf 'Error: cleanzip command not found. Ensure jp-scripts/bin is on PATH and cleanzip is installed.\n' >&2
  exit 1
fi

DRY_RUN=false
INCLUDE_ENV=false
FORCE=false

# Parse options
while [ "$#" -gt 0 ]; do
  case "$1" in
    --dry-run)
      DRY_RUN=true
      shift
      ;;
    --include-env)
      INCLUDE_ENV=true
      shift
      ;;
    --force)
      FORCE=true
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    -*)
      printf 'Error: unknown option: %s\n' "$1" >&2
      usage >&2
      exit 1
      ;;
    *)
      printf 'Error: snaprepo does not take positional arguments. Run inside a git repo.\n' >&2
      usage >&2
      exit 1
      ;;
  esac
done

REPO_PATH="$(git_repo_root || pwd)"

printf 'snaprepo: repo root is %s\n' "$REPO_PATH"

# Build flags to pass to cleanzip
CLEAZIP_ARGS=()

if [ "$DRY_RUN" = "true" ]; then
  CLEAZIP_ARGS+=( --dry-run )
fi

if [ "$INCLUDE_ENV" = "true" ]; then
  CLEAZIP_ARGS+=( --include-env )
fi

if [ "$FORCE" = "true" ]; then
  CLEAZIP_ARGS+=( --force )
fi

# Delegate to cleanzip
cleanzip "${CLEAZIP_ARGS[@]}" "$REPO_PATH"
