#!/usr/bin/env bash
set -euo pipefail

# Name: diffview
# Category: text
# Description: Pretty diff between two files or one file and stdin, using git diff --no-index.
# Usage:
#   diffview <fileA> <fileB>
#   somecmd | diffview - path/to/file
#
# Notes:
#   - Uses git diff --no-index with color.
#   - If either side is "-", stdin is captured to a temp file for that side.

if ! command -v git >/dev/null 2>&1; then
  printf 'Error: diffview requires git.\n' >&2
  exit 1
fi

if [ "$#" -ne 2 ]; then
  printf 'Usage: diffview <fileA> <fileB>\n' >&2
  printf '       somecmd | diffview - path/to/file\n' >&2
  exit 1
fi

A="$1"
B="$2"

tmpA=""
tmpB=""

cleanup() {
  [ -n "$tmpA" ] && [ -f "$tmpA" ] && rm -f "$tmpA"
  [ -n "$tmpB" ] && [ -f "$tmpB" ] && rm -f "$tmpB"
}
trap cleanup EXIT INT TERM

# If stdin is referenced as "-", capture it exactly once
if [ "$A" = "-" ] || [ "$B" = "-" ]; then
  if [ -t 0 ]; then
    printf 'Error: "-" used but no data on stdin.\n' >&2
    exit 1
  fi
  tmp_stdin="$(mktemp "${TMPDIR:-/tmp}/diffview.stdin.XXXXXX")"
  cat - >"$tmp_stdin"
fi

if [ "$A" = "-" ]; then
  tmpA="$tmp_stdin"
  A="$tmpA"
elif [ ! -f "$A" ]; then
  printf 'Error: file does not exist: %s\n' "$A" >&2
  exit 1
fi

if [ "$B" = "-" ]; then
  tmpB="$tmp_stdin"
  B="$tmpB"
elif [ ! -f "$B" ]; then
  printf 'Error: file does not exist: %s\n' "$B" >&2
  exit 1
fi

git diff --no-index --color=always -- "$A" "$B" | ${PAGER:-less} -R
