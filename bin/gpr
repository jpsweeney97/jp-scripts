#!/usr/bin/env bash
set -euo pipefail

# Name: gpr
# Category: git
# Description: Interactive GitHub PR helper using gh + fzf.
# Usage:
#   gpr              # pick a PR, then choose an action interactively
#   gpr --checkout   # pick a PR and immediately checkout its branch
#   gpr --open       # pick a PR and immediately open it in the browser
#
# Notes:
#   - Must be run inside a git repository with a GitHub remote.
#   - Requires: git, gh, fzf, jq.

usage() {
  sed -n '4,40p' "$0" | sed 's/^# \?//'
}

ACTION="menu"

while [ "$#" -gt 0 ]; do
  case "$1" in
    --checkout)
      ACTION="checkout"
      ;;
    --open)
      ACTION="open"
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      printf 'Error: unknown option: %s\n' "$1" >&2
      usage >&2
      exit 1
      ;;
  esac
  shift
done

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]:-$0}")" && pwd)"
REPO_ROOT="$(cd -- "$SCRIPT_DIR/.." && pwd)"
# shellcheck source=../lib/git.sh disable=SC1091
. "$REPO_ROOT/lib/git.sh"
# shellcheck source=../lib/fzf.sh disable=SC1091
. "$REPO_ROOT/lib/fzf.sh"

# Basic dependency checks
if ! git_require_repo; then
  exit 1
fi

if ! command -v gh >/dev/null 2>&1; then
  printf 'Error: GitHub CLI (gh) not found. Install via: brew install gh\n' >&2
  exit 1
fi

if ! fzf_require; then
  exit 1
fi

if ! command -v jq >/dev/null 2>&1; then
  printf 'Error: jq not found. Install via: brew install jq\n' >&2
  exit 1
fi

# Fetch open PRs for this repo as tab-separated lines:
# number \t title \t author \t branch \t updatedAt
pr_lines="$(
  gh pr list --limit 50 \
    --json number,title,author,headRefName,updatedAt \
    --jq '.[] | "\(.number)\t\(.title)\t\(.author.login)\t\(.headRefName)\t\(.updatedAt)"' \
    2>/dev/null || true
)"

if [ -z "$pr_lines" ]; then
  printf 'No open PRs found for this repository (or gh is not authenticated).\n' >&2
  exit 0
fi

fzf_set_common_opts "gpr> " "Select a PR (number | title | author | branch)"

selection="$(
  printf '%s\n' "$pr_lines" \
    | fzf --with-nth=1,2,3,4 \
          --delimiter=$'\t' \
          "${FZF_COMMON_OPTS[@]}"
)" || exit 0

if [ -z "$selection" ]; then
  exit 0
fi

pr_number="${selection%%$'\t'*}"
rest="${selection#*$'\t'}"
pr_title="${rest%%$'\t'*}"

printf 'Selected PR #%s: %s\n' "$pr_number" "$pr_title"

run_action() {
  case "$1" in
    open)
      echo "Opening PR #$pr_number in browser..."
      gh pr view "$pr_number" --web
      ;;
    checkout)
      echo "Checking out PR #$pr_number..."
      gh pr checkout "$pr_number"
      ;;
    view)
      echo "Showing PR #$pr_number details..."
      gh pr view "$pr_number"
      ;;
    *)
      ;;
  esac
}

case "$ACTION" in
  open)
    run_action open
    ;;
  checkout)
    run_action checkout
    ;;
  menu)
    printf 'Action? [o]pen in browser, [c]heckout branch, [v]iew details, [q]uit: '
    read -r choice
    case "$choice" in
      o|O)
        run_action open
        ;;
      c|C)
        run_action checkout
        ;;
      v|V)
        run_action view
        ;;
      *)
        echo "Aborted."
        ;;
    esac
    ;;
esac
