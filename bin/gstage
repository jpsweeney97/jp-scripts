#!/usr/bin/env bash
set -euo pipefail

# Name: gstage
# Category: git
# Description: Interactively stage changed files by number.
# Usage:
#   gstage        # list changed files and prompt which to stage
#
# Notes:
# - Must be run inside a git repo.
# - Handles simple renames by staging the new path.

if ! command -v git >/dev/null 2>&1; then
  printf 'Error: git command not found.\n' >&2
  exit 1
fi

if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  printf 'Error: gstage must be run inside a git repository.\n' >&2
  exit 1
fi

STATUS_OUTPUT="$(git status --porcelain=v1)"
if [ -z "$STATUS_OUTPUT" ]; then
  printf 'No changes to stage.\n'
  exit 0
fi

BRANCH="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || printf 'HEAD')"
printf 'Branch: %s\n' "$BRANCH"
printf 'Changed files:\n\n'

# Arrays for statuses and paths
STATUSES=()
PATHS=()

index=0
while IFS= read -r line; do
  [ -z "$line" ] && continue
  status="${line:0:2}"
  rest="${line:3}"

  # Handle renames: "old/path -> new/path" -> take new/path
  case "$rest" in
    *" -> "*)
      path="${rest##* -> }"
      ;;
    *)
      path="$rest"
      ;;
  esac

  index=$((index + 1))
  STATUSES+=("$status")
  PATHS+=("$path")
  printf '%3d) %-3s %s\n' "$index" "$status" "$path"
done <<EOF
$STATUS_OUTPUT
EOF

TOTAL="$index"
printf '\nKey: XY status from git status --porcelain (e.g., " M", "M ", "??").\n'
printf 'Select files to stage (e.g. "1 2 4-6", "a" for all, ENTER to cancel): '

read -r selection

if [ -z "$selection" ]; then
  printf 'No selection; aborting.\n'
  exit 0
fi

# If 'a' or 'all', stage everything
case "$selection" in
  a|A|all|ALL)
    printf '\nStaging ALL files...\n'
    i=0
    while [ "$i" -lt "$TOTAL" ]; do
      path="${PATHS[$i]}"
      printf '  git add -- %s\n' "$path"
      git add -- "$path"
      i=$((i + 1))
    done
    printf '\nDone. New status:\n\n'
    git status -sb || true
    exit 0
    ;;
esac

# Parse numeric selections (supports ranges like 1-3)
selected_indices=""

for token in $selection; do
  if [[ "$token" =~ ^[0-9]+-[0-9]+$ ]]; then
    start="${token%-*}"
    end="${token#*-}"
    if [ "$start" -gt "$end" ]; then
      tmp="$start"
      start="$end"
      end="$tmp"
    fi
    j="$start"
    while [ "$j" -le "$end" ]; do
      selected_indices="$selected_indices $j"
      j=$((j + 1))
    done
  elif [[ "$token" =~ ^[0-9]+$ ]]; then
    selected_indices="$selected_indices $token"
  else
    printf 'Warning: ignoring invalid token "%s"\n' "$token" >&2
  fi
done

if [ -z "$selected_indices" ]; then
  printf 'No valid indices selected; aborting.\n'
  exit 0
fi

printf '\nStaging selected files:\n'

i=1
while [ "$i" -le "$TOTAL" ]; do
  case " $selected_indices " in
    *" $i "*)
      array_index=$((i - 1))
      path="${PATHS[$array_index]}"
      printf '  [%d] git add -- %s\n' "$i" "$path"
      git add -- "$path"
      ;;
  esac
  i=$((i + 1))
done

printf '\nDone. New status:\n\n'
git status -sb || true
