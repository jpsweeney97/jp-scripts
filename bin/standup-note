#!/usr/bin/env bash
set -euo pipefail

# Name: standup-note
# Category: notes
# Description: Run standup and append the output into todayâ€™s note as a section.
# Usage:
#   standup-note
#   standup-note --days 2       # pass-through to standup
#   standup-note --section "Client X" --open

usage() {
  sed -n '4,80p' "$0" | sed 's/^# \?//'
}

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]:-$0}")" && pwd)"
REPO_ROOT="$(cd -- "$SCRIPT_DIR/.." && pwd)"
# shellcheck source=../lib/config.sh disable=SC1091
. "$REPO_ROOT/lib/config.sh"
# shellcheck source=../lib/log.sh disable=SC1091
. "$REPO_ROOT/lib/log.sh"
# shellcheck source=../lib/deps.sh disable=SC1091
. "$REPO_ROOT/lib/deps.sh"

SECTION="Standup"
OPEN_AFTER=0
FORCE=0

STANDUP_ARGS=()

while [ "$#" -gt 0 ]; do
  case "$1" in
    --section)
      [ -n "${2-}" ] || log_fatal "--section requires a name"
      SECTION="$2"
      shift 2
      ;;
    --open)
      OPEN_AFTER=1
      shift
      ;;
    --force)
      FORCE=1
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      STANDUP_ARGS+=("$1")
      shift
      ;;
  esac
done

deps_require standup "" "standup script" || exit 1

output="$(standup "${STANDUP_ARGS[@]}" || true)"

if [ -z "${output//[[:space:]]/}" ]; then
  log_warn "standup produced no output; nothing to append."
  exit 0
fi

notes_dir="$(jp_config_get notes_dir "$HOME/Notes/quick-notes" JP_NOTES_DIR)"
mkdir -p "$notes_dir"

today="$(date +%Y-%m-%d)"
note_file="$notes_dir/$today.md"
section_header="## ${SECTION} (${today})"

if [ -f "$note_file" ] && [ "$FORCE" -ne 1 ] && grep -q "^${section_header}\$" "$note_file"; then
  log_warn "Section already exists in $note_file; use --force to append again."
  exit 0
fi

{
  printf '%s\n\n' "$section_header"
  printf '%s\n\n' "$output"
} >> "$note_file"

log_info "Appended standup to $note_file"

if [ "$OPEN_AFTER" -eq 1 ]; then
  if command -v code >/dev/null 2>&1; then
    code "$note_file"
  elif [ -n "${EDITOR:-}" ]; then
    $EDITOR "$note_file"
  else
    log_warn "No editor found; appended content only."
  fi
fi
