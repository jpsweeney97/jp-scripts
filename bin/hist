#!/usr/bin/env bash
set -euo pipefail

# Name: hist
# Category: meta
# Description: Fuzzy-search your full zsh history (most recent first, de-duplicated).
# Usage:
#   hist              # pick a command, print it to stdout
#   hist --exec       # pick a command and execute it
#   hist --copy       # pick a command and copy it to clipboard (pbcopy)
#
# Notes:
#   - Reads $HISTFILE or defaults to ~/.zsh_history.
#   - Assumes zsh-style history; strips extended-history metadata if present.
#   - Uses fzf for interactive selection.

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]:-$0}")" && pwd)"
REPO_ROOT="$(cd -- "$SCRIPT_DIR/.." && pwd)"
# shellcheck source=../lib/fzf.sh disable=SC1091
. "$REPO_ROOT/lib/fzf.sh"

if ! fzf_require; then
  exit 1
fi

EXEC=false
COPY=false

usage() {
  sed -n '4,40p' "$0" | sed 's/^# \?//'
}

while [ "$#" -gt 0 ]; do
  case "$1" in
    --exec)
      EXEC=true
      ;;
    --copy)
      COPY=true
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      printf 'Error: unknown option: %s\n' "$1" >&2
      usage >&2
      exit 1
      ;;
  esac
  shift
done

if [ "$EXEC" = true ] && [ "$COPY" = true ]; then
  printf 'Error: --exec and --copy cannot be used together.\n' >&2
  usage >&2
  exit 1
fi

HISTFILE_PATH="${HISTFILE:-"$HOME/.zsh_history"}"

if [ ! -f "$HISTFILE_PATH" ]; then
  printf 'Error: history file not found at %s\n' "$HISTFILE_PATH" >&2
  exit 1
fi

# Build the history stream:
# - reverse so most recent is first (tail -r on macOS, fall back to tac/cat)
# - strip zsh extended-history prefix ": <epoch>:<duration>;"
# - drop empty lines
# - de-duplicate so only the most recent instance of each command remains
hist_stream="$(
  { tail -r "$HISTFILE_PATH" 2>/dev/null \
      || tac "$HISTFILE_PATH" 2>/dev/null \
      || cat "$HISTFILE_PATH"; } \
    | LC_ALL=C sed -E 's/^: [0-9]+:[0-9]+;//' \
    | awk 'NF && !seen[$0]++'
)"

if [ -z "$hist_stream" ]; then
  printf 'No history entries found in %s\n' "$HISTFILE_PATH" >&2
  exit 0
fi

fzf_set_common_opts "hist> " "Search history (most recent first). ENTER=select, ESC=cancel."

selected="$(
  printf '%s\n' "$hist_stream" \
    | fzf "${FZF_COMMON_OPTS[@]}" \
          --preview-window=hidden \
          --preview ' '
)" || exit 0  # fzf cancelled

# Trim leading/trailing whitespace for safety
selected="$(printf '%s' "$selected" | sed 's/^[[:space:]]*//; s/[[:space:]]*$//')"

if [ -z "$selected" ]; then
  exit 0
fi

if [ "$EXEC" = true ]; then
  printf 'Executing: %s\n' "$selected" >&2
  # shellcheck disable=SC2086
  eval "$selected"
elif [ "$COPY" = true ]; then
  if command -v pbcopy >/dev/null 2>&1; then
    printf '%s' "$selected" | pbcopy
    printf 'Copied to clipboard.\n' >&2
  else
    printf 'Warning: pbcopy not found; printing selection instead.\n' >&2
    printf '%s\n' "$selected"
  fi
else
  printf '%s\n' "$selected"
fi
